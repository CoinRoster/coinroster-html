<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>CoinRoster | My Contests</title>
    <!--#include virtual="/ssi/head.html" -->
    <link rel="stylesheet" type="text/css" href="/css/lobby.css">
    <script type="text/javascript" src="/js/account.js"></script>
    <script type="text/javascript" src="/js/lobby.js"></script>
</head>
<body>
<!--#include virtual="/ssi/nav.html" -->
<!--#include virtual="/ssi/simple_modal.html" -->
<div id="centering_container">
    <div id="body_container">
        <br/>
        <a id="contest_title" class="section_header_link">
            <!-- POPULATED BY JAVASCRIPT -->
        </a>
        <h3 id="no_data_header" class="section_header hidden">
            My Entries
        </h3>
        <!--<h3 id="contest_title" class="section_header">My Entries</h3>-->
        <table id="entry_report_table" class="contest_table"></table>
        <div id="implied_odds_disclaimer" class="full_width_right_align hidden">
            <div class="implied_odds_disclaimer">
                * Implied odds are rounded to two decimal places for display. Full precision is used for settlement.
            </div>
        </div>
        <div id="edit_roster_container" class="hidden">
            <table class="contest_detail_table">
                <tr>
                    <td id="editing_roster" class="orange"></td>
                </tr>
                <tr>
                    <td>
                        Number of entries:
                    </td>
                    <td>
                        <span id="number_of_entries" class="green"></span>
                    </td>
                    <td>
                        Remaining salary:
                    </td>
                    <td>
                        <span id="salary_cap" class="green"></span>
                    </td>
                    <td>
                        Players drafted:
                    </td>
                    <td>
                        <span id="remaining_players" class="green">0</span>
                    </td>
                </tr>
            </table>
            <div id="player_table_header">
                Available players:
            </div><!--
            --><div id="roster_table_header">
                Your roster:
            </div>
            <div id="player_table_container">
                <table id="player_table" class="player_table"></table>
            </div><!--
            --><div id="roster_table_container">
                <table id="roster_table" class="player_table"></table>
            </div>
            <div id="submit_button_container" class="submit_container">
                <button class="text_button auto_width" onclick="update_roster()">Update Roster</button>
                <button class="text_button auto_width" onclick="cancel_edit_roster()">Cancel</button>
            </div>
        </div>
    </div>
</div>
<script>

    function init()
        {
        var contest_id = get_url_param("contest_id") | 0;
        
        if (contest_id === 0) return special_no_data_message("Invalid contest ID");
        else window.contest_id = contest_id;
        
        api({
            method: "GetContestDetails",
            args: {
                contest_id: contest_id
            }
        }, function(contest)
            {
            if (contest.status === "1") 
                {
                var contest_status = contest.contest_status;
                
                id("contest_title").innerHTML = contest.title;
                id("contest_title").href = "/contest.html?id=" + contest_id;
                
                api({
                    method: "EntryReport",
                    args: {
                        contest_id: contest_id
                    }
                }, function(entries)
                    {
                    if (entries.status === "1") 
                        {
                        var 
                        
                        entry_report = entries.entry_report,
                        entry_count = entry_report.length,
                        
                        table = id("entry_report_table");
                
                        if (entry_count === 0) no_data_message(table, "You have no entries in this contest.");
                        else
                            {
                            table.className = "pari_mutuel_table";
                            
                            var option_table = JSON.parse(contest.option_table);
                            contest.option_table = option_table;
                    
                            window.contest = contest;
                            window.entries = [];
                            
                            switch (contest.contest_type)
                                {
                                case "PARI-MUTUEL" : 
                                    {
                                    show("implied_odds_disclaimer");
                                    
                                    var 
                                    
                                    user_wagers = [],
                            
                                    wager_grand_total = contest.wager_grand_total,
                                    rake_amount = multiply(contest.rake, wager_grand_total);

                                    wager_grand_total -= rake_amount;
                        
                                    var header = new_row(table, -1, [
                                        "",
                                        "Outcome",
                                        "My wagers",
                                        "Implied odds*",
                                        "Potential payout*"
                                    ]);

                                    header[0].style.background = "none";
                                    header[0].style.border = "none";
                                    header[2].style.textAlign = "left";
                                    
                                    // sum all wagers by pari-mutuel option
                                    
                                    for (var i=0; i<entry_count; i++)
                                        {
                                        var entry_item = entry_report[i],

                                        option_id = entry_item.entry_data,
                                        amount = entry_item.amount;
                                
                                        if (typeof user_wagers[option_id] === "undefined") user_wagers[option_id] = amount;
                                        else user_wagers[option_id] += amount;
                                        }
                                        
                                    // create rows for any options where user has wagers:
                                    
                                    for (var i=0; i<option_table.length; i++)
                                        {
                                        var 
                                        
                                        option_item = option_table[i],
                                        option_id = option_item.id;
                                
                                        if (typeof user_wagers[option_id] === "undefined") continue;
                                
                                        var
                                        
                                        description = option_item.description,
                                        amount = user_wagers[option_id],
                                        option_implied_odds = get_implied_odds(wager_grand_total, option_item),
                                        implied_payout = multiply(option_implied_odds, amount),
                                        
                                        row = new_row(table, -1, [
                                            option_id,
                                            description,
                                            toBTC(amount) + " BTC",
                                            option_implied_odds,
                                            toBTC(implied_payout) + " BTC"
                                        ]);

                                        row[1].width = "1";
                                        row[2].style.textAlign = "left";
                                        }
                                
                                    break;
                                    }
                                case "ROSTER" : 
                                    {
                                    var player_names = [];
                                    
                                    for (var i=0; i<option_table.length; i++)
                                        {
                                        var option_item = option_table[i];
                                        player_names[option_item.id] = option_item.name;
                                        }
                                    
                                    var header_content = [
                                        "Roster ID",
                                        "Entries",
                                        "Amount",
                                        "",
                                        "Roster"
                                    ];
                                    
                                    if (contest_status === 1) header_content.push("Action");
                                    
                                    var header = new_row(table, -1, header_content);

                                    header[0].style.background = "none";
                                    header[0].style.border = "none";
                                    header[5].style.textAlign = "left";
                                    
                                    for (var i=0; i<entry_count; i++)
                                        {
                                        var entry_item = entry_report[i],

                                        entry_id = entry_item.id,
                                        amount = entry_item.amount,
                                        roster = JSON.parse(entry_item.entry_data),
                                        number_of_entries = divide(amount, contest.cost_per_entry),
                                        roster_html = "";
                                
                                        entry_item.roster = roster;
                                        entry_item.number_of_entries = number_of_entries;
                                
                                        window.entries[entry_id] = entry_item;
                                        
                                        for (var j=0; j<roster.length; j++)
                                            {
                                            if (j !== 0) roster_html += "<br/>";
                                            roster_html += player_names[roster[j].id] + " ($" + toCurrency(roster[j].price) + ")";
                                            }
                                            
                                        var row_content = [
                                            entry_id,
                                            number_of_entries,
                                            amount + " BTC",
                                            "",
                                            roster_html
                                        ];
                                        
                                        if (contest_status === 1) row_content.push("<button class=\"text_button orange orange_border\" style=\"width:auto\" onclick=\"edit_roster(" + entry_id + ")\">Edit roster</button>");

                                        var row = new_row(table, -1, row_content);

                                        row[1].width = "1";
                                        row[1].style.textAlign = "center";
                                        row[2].width = "1";
                                        row[2].style.textAlign = "center";
                                        row[3].width = "1";
                                        row[3].style.whiteSpace = "nowrap";
                                        row[5].style.textAlign = "left";
                                        }
                                    break;
                                    }
                                }
                            }
                        }
                    });
                }
            else special_no_data_message(contest.error);
            });
        }
        
    function special_no_data_message(message)
        {
        var table = id("entry_report_table");
        hide("contest_title");
        show("no_data_header");
        no_data_message(table, message);
        }
        
    function edit_roster(entry_id)
        {
        id("player_table").innerHTML = "";
        id("roster_table").innerHTML = "";
                    
        var 
        
        contest = window.contest,
        option_table = contest.option_table,
        entry = window.entries[entry_id],
        roster = entry.roster;

        window.active_entry = entry_id;
        
        id("editing_roster").innerHTML = "Editing Roster " + entry_id;

        id("number_of_entries").innerHTML = entry.number_of_entries;
        id("salary_cap").innerHTML = "$" + toCurrency(contest.salary_cap);
        if (contest.roster_size !== 0) id("remaining_players").innerHTML = "0/" + contest.roster_size;
        else id("remaining_players").innerHTML = 0;
            
        for (var i=0; i<option_table.length; i++)
            {
            var player_item = option_table[i],
                    
            player_id = player_item.id,
            name = player_item.name,
            price = player_item.price;
    
            insert_player_row("player_table", player_id, name, price);
            }
                        
        for (var i=0; i<roster.length; i++) add_player(roster[i].id);
        
        show("edit_roster_container");
        
        id("player_table_container").scrollTop = 0;
        id("roster_table_container").scrollTop = 0;
                
        window.scrollTo(0, document.body.scrollHeight);
        }
        
    function cancel_edit_roster()
        {
        hide("edit_roster_container");
        }
        
    function update_roster()
        {
        var roster = get_valid_roster();
        
        if (typeof roster === "undefined") return; // caused if get_valid_roster() throws a simple modal alert

        api({
            method: "UpdateRoster",
            args: {
                contest_id: window.contest_id,
                entry_id: window.active_entry,
                roster: roster
            }
        }, function(call)
            {
            if (call.status === "1")
                {
                return show_simple_modal("Your roster has been updated", "good", function()
                    {
                    location.reload();
                    });
                }
            else show_simple_modal(call.error, "bad", null);
            });
        }
   
</script>
<script type="text/javascript" src="/js/nav.js"></script>
<!--#include virtual="/ssi/google_analytics.html" -->
</body>
</html>
