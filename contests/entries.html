<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>CoinRoster | My Contests</title>
    <!--#include virtual="/ssi/head.html" -->
    <link rel="stylesheet" type="text/css" href="/css/lobby.css">
    <script type="text/javascript" src="/js/account.js"></script>
    <script type="text/javascript" src="/js/lobby.js"></script>
</head>
<body>
<!--#include virtual="/ssi/nav.html" -->
<!--#include virtual="/ssi/simple_modal.html" -->
<div id="centering_container">
    <div id="body_container">
        <br/>
        <h3 id="contest_title" class="section_header">
            My Entries
        </h3>
        <div id="exposure_container">
            Exposure:<span id="exposure_value" class="orange"></span>
        </div>
    </div>
    <div class="table_body_container">
        <table id="roster_entry_report_table" class="contest_table entry_report_table"></table>
        <table id="pari_mutuel_entry_report_table" class="contest_table entry_report_table"></table>
        <div id="pari_mutuel_explanation" class="hidden">
            * The gross payout is the total amount that you will receive if a given outcome wins.
            <br/><br/>
            * The scenario P/L is the net profit or loss that you will realize if a given outcome wins,
            taking into account your total exposure to the pool. 
            <br/><br/>
            * Both figures factor in the rake.
        </div>
        <div id="edit_roster_container" class="hidden">
            <ul id="editing_roster_ul">
                <li>
                    <div id="editing_roster" class="orange"></div>
                </li>
                <li>
                    <span id="cancel_edit_roster_inline" onclick="cancel_edit_roster()">Cancel</span>
                </li>
            </ul>
            <ul class="roster_parameter_table">
                <li class="roster_parameter_label">
                    <span id="number_verbose">Number</span>
                    <span id="number_sign" class="hidden">#</span>
                    of entries?
                </li>
                <li id="number_of_entries_li">
                    <span id="number_of_entries" class="green"></span>
                </li>
                <li id="entry_value_li" class="green">
                    &rarr;<span id="entry_value"></span>
                </li>
            </ul>
            <ul class="roster_parameter_table">
                <li class="roster_parameter_label">
                    Remaining salary:
                </li>
                <li>
                    <span id="salary_cap" class="green"></span>
                </li>
            </ul>
            <ul class="roster_parameter_table">
                <li class="roster_parameter_label">
                    Players drafted:
                </li>
                <li>
                    <span id="remaining_players" class="green">0</span>
                </li>
            </ul>
            <div id="player_table_header" class="player_table_header">
                Available players:
                <br/>
                <span class="click_to">
                    Click to draft
                </span>
            </div><!--
            --><div id="roster_table_header" class="player_table_header">
                Your roster:
                <br/>
                <span class="click_to">
                    Click to drop
                </span>
            </div>
            <div id="player_table_container" class="player_table_container">
                <table id="player_table" class="player_table"></table>
            </div><!--
            --><div id="roster_table_container" class="player_table_container">
                <table id="roster_table" class="player_table"></table>
            </div>
            <div id="submit_button_container" class="submit_container">
                <button id="submit_roster_button" class="text_button auto_width" onclick="update_roster()">Update Roster</button>
                <button class="text_button auto_width" onclick="cancel_edit_roster()">Cancel</button>
            </div>
        </div>
    </div>
</div>
<script>

    function init()
        {
        var contest_id = get_url_param("contest_id") | 0;
        
        if (contest_id === 0) return special_no_data_message("Invalid contest ID");
        else window.contest_id = contest_id;
        
        api({
            method: "GetContestDetails",
            args: {
                contest_id: contest_id
            }
        }, function(contest)
            {
            if (contest.status === "1") 
                {
                var contest_status = contest.contest_status;
                
                id("contest_title").innerHTML = contest.title;
                id("contest_title").href = "/contest.html?id=" + contest_id;
                
                api({
                    method: "EntryReport",
                    args: {
                        contest_id: contest_id
                    }
                }, function(entries)
                    {
                    if (entries.status === "1") 
                        {
                        var 
                        
                        entry_report = entries.entry_report,
                        entry_count = entry_report.length;
                
                        if (entry_count === 0) no_data_message(table, "You have no entries in this contest.");
                        else
                            {                            
                            var option_table = JSON.parse(contest.option_table);
                            contest.option_table = option_table;
                    
                            window.contest = contest;
                            window.entries = [];
                            
                            switch (contest.contest_type)
                                {
                                case "PARI-MUTUEL" : 
                                    {
                                    destroy("roster_entry_report_table");
                                    show("pari_mutuel_explanation");
                                    
                                    var 
                                    
                                    table = id("pari_mutuel_entry_report_table"),
                                    
                                    user_wagers = [],
                                    user_exposure = 0,
                            
                                    wager_grand_total = contest.wager_grand_total,
                                    rake_amount = multiply(contest.rake, wager_grand_total);

                                    wager_grand_total -= rake_amount;
                        
                                    var header = new_row(table, -1, [
                                        "Outcome",
                                        "My wagers",
                                        "Odds",
                                        "Gross payout",
                                        "Scenario P/L"
                                    ]);

                                    header[1].style.textAlign = "left";
                                    
                                    // sum all wagers by pari-mutuel option
                                    
                                    for (var i=0; i<entry_count; i++)
                                        {
                                        var entry_item = entry_report[i],

                                        option_id = entry_item.entry_data,
                                        amount = entry_item.amount;
                                
                                        if (typeof user_wagers[option_id] === "undefined") user_wagers[option_id] = amount;
                                        else user_wagers[option_id] += amount;
                                        
                                        user_exposure += amount;
                                        }
                                        
                                    id("exposure_value").innerHTML = toBTC(user_exposure) + " BTC";
                                        
                                    // create rows for any options where user has wagers:
                                    
                                    for (var i=0; i<option_table.length; i++)
                                        {
                                        var 
                                        
                                        option_item = option_table[i],
                                        option_id = option_item.id,
                                        description = option_item.description,
                                        amount = "--", // default is no wager
                                        option_implied_odds = get_implied_odds(wager_grand_total, option_item),
                                        implied_payout = "--", // default is no wager, therefore no payout
                                        scenario_PL = -user_exposure, // default is no wager, therefore total loss
                                        scenario_PL_class = "orange"; // default is total loss
                                        
                                        if (typeof user_wagers[option_id] !== "undefined") // user has a wager
                                            {
                                            amount = user_wagers[option_id],
                                            implied_payout = multiply(option_implied_odds, amount),
                                            scenario_PL = implied_payout - user_exposure;
                                         
                                            if (scenario_PL > 0) scenario_PL_class = "green"; // override if profit
                                            
                                            amount = toBTC(amount) + " BTC";
                                            implied_payout = toBTC(implied_payout) + " BTC";
                                            }
                                        
                                        var row = new_row(table, -1, [
                                            description,
                                            "<div class='field_label'>My Wagers:</div>" + amount,
                                            "<div class='field_label'>Odds:</div>" + option_implied_odds,
                                            "<div class='field_label'>Gross payout:</div>" + implied_payout,
                                            "<div class='field_label'>Scenario P/L:</div><span class='" + scenario_PL_class + "'>" + toBTC(scenario_PL, false, true) + " BTC</span>"
                                        ]);

                                        row[1].style.textAlign = "left";
                                        }
                                
                                    break;
                                    }
                                case "ROSTER" : 
                                    {
                                    destroy("pari_mutuel_entry_report_table");
                                    
                                    var 
                                    
                                    table = id("roster_entry_report_table"),
                                    
                                    player_names = [],
                                    
                                    user_exposure = 0;
                                    
                                    for (var i=0; i<option_table.length; i++)
                                        {
                                        var option_item = option_table[i];
                                        player_names[option_item.id] = option_item.name;
                                        }
                                    
                                    var header = new_row(table, -1, [
                                        "Roster",
                                        "Roster ID",
                                        "Wager",
                                    ]);
                                    
                                    header[1].style.textAlign = "left";
                                        
                                    for (var i=0; i<entry_count; i++)
                                        {
                                        var entry_item = entry_report[i],

                                        entry_id = entry_item.id,
                                        amount = entry_item.amount,
                                        roster = JSON.parse(entry_item.entry_data),
                                        number_of_entries = divide(amount, contest.cost_per_entry),
                                        roster_html = "";
                                
                                        user_exposure += amount;
                                
                                        entry_item.roster = roster;
                                        entry_item.number_of_entries = number_of_entries;
                                
                                        window.entries[entry_id] = entry_item;
                                        
                                        for (var j=0; j<roster.length; j++)
                                            {
                                            if (j !== 0) roster_html += "<br/>";
                                            roster_html += "<span class='inline_player_name'>" + player_names[roster[j].id] + "</span><span class='inline_player_price'>$" + commas(roster[j].price | 0) + "</span>";
                                            }
                                            
                                        var enter_button = "";
                                        
                                        if (contest_status === 1) enter_button = "<button class=\"text_button orange orange_border\" style=\"width:auto;float:right;\" onclick=\"edit_roster(" + entry_id + ")\">Edit roster</button>";

                                        var row = new_row(table, -1, [
                                            "<ul><li>" + roster_html + "</li><li>" + enter_button + "</li></ul>",
                                            "<div class='field_label'>Roster ID:</div>" + "#" + entry_id,
                                            "<div class='field_label'>Wager:</div>" + amount + " BTC"
                                        ]);

                                        row[1].style.textAlign = "left";
                                        }
                                        
                                    id("exposure_value").innerHTML = toBTC(user_exposure) + " BTC";
                                    
                                    break;
                                    }
                                }
                            }
                        }
                    });
                }
            else special_no_data_message(contest.error);
            });
        }
        
    function special_no_data_message(message)
        {
        var table = id("entry_report_table");
        hide("contest_title");
        show("contest_title");
        no_data_message(table, message);
        }
        
    function edit_roster(entry_id)
        {
        id("player_table").innerHTML = "";
        id("roster_table").innerHTML = "";
                    
        var 
        
        contest = window.contest,
        option_table = contest.option_table,
        entry = window.entries[entry_id],
        roster = entry.roster;

        window.active_entry = entry_id;
        
        id("editing_roster").innerHTML = "Editing Roster " + entry_id;

        id("number_of_entries").innerHTML = entry.number_of_entries;
        id("entry_value").innerHTML = toBTC(entry.amount) + " BTC";
        id("salary_cap").innerHTML = "$" + commas(contest.salary_cap | 0);
        if (contest.roster_size !== 0) id("remaining_players").innerHTML = "0/" + contest.roster_size;
        else id("remaining_players").innerHTML = 0;
            
        for (var i=0; i<option_table.length; i++)
            {
            var player_item = option_table[i],
                    
            player_id = player_item.id,
            name = player_item.name,
            price = player_item.price;
    
            insert_player_row("player_table", player_id, name, price);
            }
                        
        for (var i=0; i<roster.length; i++) add_player(roster[i].id);
        
        show("edit_roster_container");
        
        id("player_table_container").scrollTop = 0;
        id("roster_table_container").scrollTop = 0;
                
        window.scrollTo(0, id("editing_roster").offsetTop);
        }
        
    function cancel_edit_roster()
        {
        window.scroll(0,0);
        hide("edit_roster_container");
        }
        
    function update_roster()
        {
        var roster = get_valid_roster();
        
        if (typeof roster === "undefined") return; // caused if get_valid_roster() throws a simple modal alert

        api({
            method: "UpdateRoster",
            args: {
                contest_id: window.contest_id,
                entry_id: window.active_entry,
                roster: roster
            }
        }, function(call)
            {
            if (call.status === "1")
                {
                return show_simple_modal("Your roster has been updated", "good", function()
                    {
                    location.reload();
                    });
                }
            else show_simple_modal(call.error, "bad", null);
            });
        }
   
</script>
<script type="text/javascript">
    window.nav_text = "My entries in contest #" + get_url_param("contest_id");
</script>
<script type="text/javascript" src="/js/nav.js"></script>
<!--#include virtual="/ssi/google_analytics.html" -->
</body>
</html>
