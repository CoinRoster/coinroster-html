<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>CoinRoster | My Account</title>
    <!--#include virtual="/ssi/head.html" -->
    <link rel="stylesheet" type="text/css" href="/css/account.css">
    <script type="text/javascript" src="/js/account.js"></script>
</head>
<body>
<!--#include virtual="/ssi/nav.html" -->
<!--#include virtual="/ssi/simple_modal.html" -->
<div id="centering_container">
    <div id="body_container">
        <br/>
        <hr noshade size="1"/>
        <h3 class="section_header">My Account</h3>
        <div style="margin-bottom:40px;">
            <table id="balance_wrapper_table">
                <tr>
                    <td width="1" style="padding-right:60px;">
                        <table class="balance_table">
                            <tr>
                                <td id="btc_balance" class="balance_field">
                                    <!-- POPULATED BY JAVASCRIPT -->
                                </td>
                                <td style="padding-right:0">
                                    BTC
                                </td>
                            </tr>
                            <tr>
                                <td id="rc_balance" class="balance_field" style="padding-bottom:24px">
                                    <!-- POPULATED BY JAVASCRIPT -->
                                </td>
                                <td style="padding-right:0;padding-bottom:24px">
                                    RC
                                </td>
                            </tr>
                            <tr style="border-top:1px solid white;">
                                <td id="available_balance" class="balance_field" style="padding-top:24px;">
                                    
                                </td>
                                <td style="padding-right:0;padding-top:24px;">
                                    TOTAL
                                </td>
                            </tr>
                        </table>
                    </td>
                    <td>
                        <table class="deposit_withdraw_table">
                            <tr>
                                <td>
                                    <a class="link" onclick="deposit();">Deposit BTC</a>
                                </td>
                                <td>
                                    <a class="link" onclick="withdraw();">Withdraw BTC</a>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </div>
        
        <a class="subwindow clickable_subwindow link_subwindow" href="/contests">
            My Contests
        </a>
        
        <div class="subwindow hidden_subwindow" toggle="Transactions">
            <div class="subwindow_heading">
                Transactions
            </div>
            <br/>
            <br/>
            <div id="transaction_report_table"></div>
        </div>
              
        <div id="add_ext_address_subwindow" class="subwindow hidden_subwindow" toggle="Connect a Bitcoin wallet">
            <div class="subwindow_heading">
                Connect a Bitcoin wallet
            </div>
            <br/>
            <div class="input_padding description_text">
                To make deposits to CoinRoster, we need to know the public address of your
                <br/>
                Bitcoin wallet. This way, when funds come in from your wallet, we know they
                <br/>
                came from you and can credit your account.
                <br/>
                <br/>
            </div>
            <form onsubmit="return update_ext_address('add_ext_address');">
                <div class="input_padding">
                    <input id="add_ext_address" type="text" class="input_style email_input" placeholder="Bitcoin wallet address"  maxlength="35"/>
                    <button type="submit" class="text_button auto_width add_left_margin">Connect wallet</button>
                </div>
            </form>
        </div>
        
        <div id="manage_ext_address_subwindow" class="subwindow hidden_subwindow" toggle="Your Bitcoin wallet">
            <div class="subwindow_heading">
                Your Bitcoin wallet
            </div>
            <br/>
            <br/>
            <div id="display_ext_address">
                <span id="ext_address" class="teal"></span>
                <button id="change_ext_address_button" class="text_button auto_width add_left_margin" onclick="hide('display_ext_address');show('change_ext_address');">Change wallet address</button>
            </div>
            <div id="change_ext_address" style="display:none">
                <form onsubmit="return update_ext_address('new_ext_address');">
                    New wallet address:
                    <input id="new_ext_address" type="text" class="input_style email_input add_left_margin" placeholder="wallet address" maxlength="60"/>
                    <button type="submit" class="text_button auto_width add_left_margin">Submit</button>
                <button class="text_button auto_width add_left_margin" onclick="hide('change_ext_address');show('display_ext_address');return false;">Cancel</button>
                </form>
            </div>
            <br/>
            <hr noshade>
            <br/>
            <span id="must_withdraw_bitcon" style="display:none">
                <span class="teal">
                    Wallet security is ENABLED
                </span>
                <br/>
                <br/>
                You must withdraw all Bitcoin from this account in order to change your wallet address.
            </span>
            <span id="security_is_enabled" style="display:none">
                <span class="teal">
                    Wallet security is ENABLED
                </span>
                <br/>
                <br/>
                With security enabled, you will NOT be able to change your wallet address if
                <br/>
                there are Bitcoins in your CoinRoster account. This is meant to stop a hacker 
                <br/>
                from withdrawing your Bitcoins to a new wallet.
                <br/>
                <br/>
                If you want, you can click the button below to DISABLE this security measure. 
                <br/>
                You will be free to change your wallet address at any time. 
                <br/>
                <br/>
                <a href="/wallet_security.html" style="color:white">Click here for a complete explanation</a>
                <br/>
                <br/>
                <br/>
                <button class="text_button auto_width" onclick="update_ext_address_security(0);">Disable wallet security</button>
            </span>
            <span id="enable_security" style="display:none">
                <span class="orange">
                    Wallet security is DISABLED
                </span>
                <br/>
                <br/>
                With security disabled, you can change your wallet address at any time.
                <br/>
                <br/>
                If you would like to enable wallet security and prevent wallet changes while
                <br/>
                there are Bitcoins in your account, please click here:
                <br/>
                <br/>
                <span id="your_next_opportunity" style="display:none">
                    Your next opportunity to disable wallet security will be after you withdraw
                    <br/>
                    all Bitcoins in your account to your connected wallet.
                    <br/>
                    <br/>
                </span>
                <button class="text_button auto_width" onclick="update_ext_address_security(1);">Enable wallet security</button>
            </span>
        </div>
        
        <div id="add_email_subwindow" class="subwindow hidden_subwindow" toggle="Add email address">
            <div id="add_email_message" class="subwindow_heading">
                Add email address
            </div>
            <br/>
            <div class="input_padding description_text">
                <span class="orange">
                    We will only send you emails about activity in your account. Your email will also
                    <br/>
                    be used if you ever need to recover your password. We will not sell or share your
                    <br/>
                    email address with a third party.
                </span>
                <br/>
                <br/>
                We have a weekly newsletter featuring news updates from the world of bitcoin,
                <br/>
                gaming, and sports. To sign up, please click here:
            </div>
            <label id="newsletter_label" class="checkbox_label">
                <input id="newsletter_checkbox" type="checkbox" name="checkbox" value="value">
                Sign up for our newsletter
            </label>
            <form onsubmit="return add_email_address();">
                <div class="input_padding">
                    <input id="new_email_address" type="text" class="input_style email_input" placeholder="e-mail address"  maxlength="60"/>
                    <button type="submit" class="text_button auto_width add_left_margin">Submit</button>
                </div>
            </form>
        </div>
        
        <div id="manage_email_subwindow" class="subwindow hidden_subwindow" toggle="Manage e-mail">
            <div id="manage_email_message" class="subwindow_heading">
                Manage e-mail
            </div>
            <br/>
            <br/>
            <div id="manage_email">
                <span id="email_on_file"></span>
                <span id="verified_unverified"></span>
                <span id="verification_button">
                    <button type="submit" class="text_button auto_width add_left_margin" onclick="resend_verification();">Re-send verification</button>
                </span>
                <span id="verification_message">
                    Verification Sent!
                </span>
                <button class="text_button auto_width add_left_margin" onclick="hide('manage_email');show('change_email');">Change e-mail address</button>
            </div>
            <div id="change_email" style="display:none">
                <form onsubmit="return change_email_address();" style="display:inline-block">
                    <span id="change_email_message">New e-mail address:</span>
                    <input id="new_email_address" type="text" class="input_style email_input add_left_margin" placeholder="e-mail address" maxlength="60"/>
                    <button type="submit" class="text_button auto_width add_left_margin">Submit</button>
                </form>
                <button class="text_button auto_width add_left_margin" onclick="cancel_change_email();" style="display:inline-block">Cancel</button>
            </div>
            <br/>
            <hr noshade>
            <br/>
            <span id="subscribe_unsubscribe_message"></span>
            <button id="subscribe_unsubscribe_button" type="submit" class="text_button auto_width add_left_margin" onclick="toggle_subscription();"></button>
        </div>
        
        <div class="subwindow hidden_subwindow" toggle="Change password">
            <div id="change_password_message" class="subwindow_heading">
                Change password
            </div>
            <br/>
            <br/>
            <form onsubmit="return change_password();">
                <input type="password" style="position:absolute;top:-5000px;"/>
                <input id="old_password" type="password" class="input_style" placeholder="Old password" />
                <input id="new_password" type="password" class="input_style add_left_margin" placeholder="New password" />
                <input id="confirm_password" type="password" class="input_style add_left_margin" placeholder="Confirm new password" />
                <button type="submit" class="text_button auto_width add_left_margin">Submit</button>
            </form>
        </div>
        
        <a class="subwindow clickable_subwindow link_subwindow" href="refer.html">
            Refer a friend and earn cash!
        </a>

    </div>
</div>
<script type="text/javascript" src="/js/btc_inputs.js"></script>
<script>

    // DEPOSIT AND WITHDRAWAL HANDLERS

    function deposit()
        {
        var ext_address = get_ext_address(true);

        if (ext_address === "") show_simple_modal("You must connect a Bitcoin wallet to your account", "good", function()
            {
            id("add_ext_address_subwindow_toggle").click();
            });
        else location = "deposit.html";
        }

    function withdraw()
        {
        var btc_balance = get_btc_balance();

        if (+btc_balance === 0) show_simple_modal("You have no BTC to withdraw", "bad", null);
        else location = "withdraw.html";
        }

//--------------------------------------------------------------------------------------------------

    function reset_error_messages()
        {
        change_password_error("Change password", "white");
        if (id("add_email_subwindow")) add_email_error("Add e-mail address", "white");
        if (id("manage_email_subwindow")) change_email_error("New e-mail address:", "white");
        }

//--------------------------------------------------------------------------------------------------

    // POPULATE ACCOUNT DATA
    
    function populate_account_data()
        {
        api({ 
            method: "GetAccountDetails", 
            args: {} 
        }, function(call)
            {
            if (call.status === "1")
                {
                var 

                btc_balance = call.btc_balance,
                rc_balance = call.rc_balance,
                ext_address = call.ext_address,
                email_address = call.email_address,
                email_ver_flag = call.email_ver_flag,
                newsletter_flag = call.newsletter_flag,
                ext_address_secure_flag = call.ext_address_secure_flag;

                id("btc_balance").innerHTML = toBTC(btc_balance, true);
                id("rc_balance").innerHTML = toBTC(rc_balance, true);
                id("available_balance").innerHTML = toBTC(add(btc_balance, rc_balance), true);

                if (ext_address === "") destroy("manage_ext_address_subwindow");
                else
                    {
                    destroy("add_ext_address_subwindow");
                    
                    id("ext_address").innerHTML = ext_address;
                    if (ext_address_secure_flag === 1)
                        {
                        if (btc_balance > 0)
                            {
                            hide("change_ext_address_button");
                            show("must_withdraw_bitcon");
                            }
                        else
                            {
                            show("security_is_enabled");
                            }
                        }
                    else if (ext_address_secure_flag === 0)
                        {
                        show("enable_security");
                        if (btc_balance > 0)
                            {
                            show("your_next_opportunity");
                            }
                        }
                    }

                if (email_address === "") destroy("manage_email_subwindow");
                else 
                    {
                    destroy("add_email_subwindow");
                    id("email_on_file").innerHTML = email_address; 
                    if (email_ver_flag === 1)
                        {
                        id("verified_unverified").innerHTML = "&nbsp;&nbsp;(verified)";
                        id("email_on_file").style.color = cr_teal;
                        id("verified_unverified").style.color = cr_teal;
                        hide("verification_button");
                        }
                    else
                        {
                        id("verified_unverified").innerHTML = "&nbsp;&nbsp;(unverified)";
                        id("email_on_file").style.color = "orange";
                        id("verified_unverified").style.color = "orange";
                        }
                    update_subscription_view(newsletter_flag);
                    }
                }
            (function(subwindows)
                {
                for (var i=0; i<subwindows.length; i++)
                    {
                    //alert(subwindows[i].id);
                    var 

                    subwindow_toggle = document.createElement("div");
                    subwindow_toggle.innerHTML = subwindows[i].getAttribute("toggle");
                    subwindow_toggle.className = "subwindow clickable_subwindow";

                    if (typeof subwindows[i].id !== "undefined") subwindow_toggle.id = subwindows[i].id + "_toggle";

                    subwindow_toggle.onclick = (function(subwindow, subwindow_toggle) 
                        {
                        return function()
                            {
                            if (typeof window.subwindow !== "undefined")
                                {
                                window.subwindow.style.display = "none";
                                window.subwindow_toggle.style.display = "block";
                                }
                            window.subwindow = subwindow;
                            window.subwindow_toggle = subwindow_toggle;
                            subwindow.style.display = "block";
                            subwindow_toggle.style.display = "none";
                            };
                        })(subwindows[i], subwindow_toggle);

                    var 

                    hide_button = document.createElement("div");
                    hide_button.className = "hide_button";
                    hide_button.innerHTML = "hide";
                    hide_button.onclick =  (function(subwindow, subwindow_toggle) 
                        {
                        return function()
                            {
                            subwindow.style.display = "none";
                            subwindow_toggle.style.display = "block";
                            reset_error_messages();
                            };
                        })(subwindows[i], subwindow_toggle);

                    subwindows[i].appendChild(hide_button);
                    subwindows[i].parentNode.insertBefore(subwindow_toggle, subwindows[i]);
                    }
                })(document.getElementsByClassName("hidden_subwindow"));

            var hash = location.hash.slice(1);
            switch(hash)
                {
                case "add_wallet" :
                    id("add_ext_address_subwindow_toggle").click();
                    break;
                default :
                    // do nothing
                }
            });
        }
        
//--------------------------------------------------------------------------------------------------

    // TRANSACTION REPORT

    function transaction_report()
        {
        var 

        start_date_ms = 0, 
        end_date_ms = 9999999999999;

        api({
            method: "TransactionReport",
            args: {
                start_date_ms: start_date_ms,
                end_date_ms: end_date_ms,
                request_source: "account_panel"
            }
        }, function(call)
            {
            if (call.status === "1") 
                {
                var
                transaction_report_array = call.transaction_report,
                number_of_transactions = transaction_report_array.length;
                function new_row(table, row_index, data)
                    {
                    var row = table.insertRow(row_index),
                    array = [row];
                    for (var i=0; i<data.length; i++)
                        {
                        var cell = row.insertCell(i); 
                        cell.innerHTML = data[i];
                        array.push(cell);
                        }

                    array[1].style.textAlign = "right";
                    array[5].style.textAlign = "right";

                    return array;
                    }

                var table = new_table("transaction_report_table"),
                row_count = 0;

                if (number_of_transactions > 0)
                    {
                    // create rows:

                    for (var i=number_of_transactions-1; i>=0; i--)
                        {
                        var transaction_item = transaction_report_array[i],

                        transaction_id = transaction_item.transaction_id,
                        created = transaction_item.created,
                        trans_type = transaction_item.trans_type,
                        amount = transaction_item.amount,
                        from_currency = transaction_item.from_currency,
                        memo = transaction_item.memo,
                        memo_link = "<a class=\"memo_link teal\">Memo</a>",
                        pending_flag = transaction_item.pending_flag,

                        created_date = dateconv_ms_to_string(created),
                        created_time = dateconv_ms_to_time(created);

                        if (pending_flag === "1") trans_type += " (pending)";
                        
                        if (memo === "") memo_link = "";

                        var row = new_row(table, row_count++, [
                            "#" + transaction_id,
                            created_date + " at " + created_time,
                            trans_type,
                            memo_link,
                            amount,
                            from_currency
                            //memo
                        ]);
                        
                        if (memo !== "")
                            {
                            row[4].onclick = (function(memo)
                                {
                                return function()
                                    {
                                    show_simple_modal(memo, "good", null);
                                    }
                                })(memo);
                            }
                        }

                    /*var header = new_row(table, 0, [
                        "Created",
                        "Transaction",
                        "Amount",
                        "Currency",
                        "Memo"
                    ]);

                    // style headers:

                    for (var i=1; i<header.length; i++) header[i].className = "header_cell";*/
                    }
                else id("transaction_report_table").innerHTML = "No transactions found";
                }
            });
        }

//--------------------------------------------------------------------------------------------------

    // CONNECT BITCOIN WALLET

    function update_ext_address(_id)
        {
        var ext_address = id(_id).value;

        api({
            method: "UpdateExtAddress",
            args: {
                ext_address: ext_address,
                update_for_active_user: true
            }
        }, function()
            {
            location.reload();
            });
        }

    function update_ext_address_security(ext_address_secure_flag)
        {
        api({
            method: "UpdateExtAddressSecurity",
            args: {
                ext_address_secure_flag: ext_address_secure_flag
            }
        }, function()
            {
            location.reload();
            });
        }

//--------------------------------------------------------------------------------------------------

    // ADD / CHANGE / MANAGE EMAIL ADDRESS

    function add_email_error(message)
        {
        id("add_email_message").innerHTML = message;
        id("add_email_message").style.color = "orange";
        }

    function change_email_error(message, color)
        {
        id("change_email_message").innerHTML = message;
        id("change_email_message").style.color = color;
        }
        
    function add_email_address()
        {
        var new_email_address = id("new_email_address").value,
        newsletter_flag = id("newsletter_checkbox").checked ? 1 : 0;

        if (validate_email(new_email_address) === false)
            {
            add_email_error("Invalid email address");
            return false;
            }

        api({
            method: "AddEmailAddress",
            args: {
                email_address: new_email_address,
                newsletter_flag: newsletter_flag
            }
        }, function()
            {
            location.reload();
            });
        }

    function change_email_address()
        {
        var new_email_address = id("new_email_address").value;

        if (new_email_address === id("email_on_file").innerHTML)
            {
            change_email_error("Email address is on file", "orange");
            return false;
            }
        if (validate_email(new_email_address) === false)
            {
            change_email_error("Invalid email address", "orange");
            return false;
            }

        api({
            method: "ChangeEmailAddress",
            args: {
                email_address: new_email_address
            }
        }, function()
            {
            location.reload();
            });
        }

    function cancel_change_email()
        {
        change_email_error("New e-mail address:", "white");
        hide('change_email');
        show('manage_email');
        return false;
        }

    function resend_verification()
        {
        api({
            method: "SendEmailVerification",
            args: {}
        }, function(call)
            {
            if (call.status === "1")
                {
                hide("verification_button");
                id("verification_message").style.display = "inline-block"; // don't use show() - must be inline
                }
            });
        }

//--------------------------------------------------------------------------------------------------

    // TOGGLE NEWSLETTER SUBSCRIPTION

    function update_subscription_view(newsletter_flag)
        {
        id("subscribe_unsubscribe_message").current_state = newsletter_flag;
        if (newsletter_flag === 1)
            {
            id("subscribe_unsubscribe_message").innerHTML = "You <span class=\"underline\">are</span> subscribed to our newsletter";
            id("subscribe_unsubscribe_button").innerHTML = "Unsubscribe";
            }
        else
            {
            id("subscribe_unsubscribe_message").innerHTML = "You <span class=\"underline\">are not</span> subscribed to our newsletter"; 
            id("subscribe_unsubscribe_button").innerHTML = "Subscribe";
            }
        }

    function toggle_subscription()
        {
        var current_flag_state = id("subscribe_unsubscribe_message").current_state;

        api({
            method: "ChangeNewsletterFlag",
            args: {
                current_flag_state: current_flag_state
            }
        }, function(call)
            {
            if (call.status === "1") 
                {
                var newsletter_flag = call.newsletter_flag;
                update_subscription_view(newsletter_flag);
                }
            });
        }

//--------------------------------------------------------------------------------------------------

    // CHANGE PASSWORD

    function change_password_error(message, color)
        {
        id("change_password_message").innerHTML = message;
        id("change_password_message").style.color = color;
        id("new_password").value = "";
        id("confirm_password").value = "";
        }

    function change_password()
        {
        var old_password = id("old_password").value,
        new_password = id("new_password").value,
        confirm_password = id("confirm_password").value;

        if (old_password === "")
            {
            change_password_error("Enter your old password", "orange");
            set_focus("old_password");
            return false;
            }

        if (old_password.length < 8) 
            {
            change_password_error("Old password must be 8 characters or longer", "orange");
            id("old_password").value = "";
            set_focus("old_password");
            return false;
            }

        if (new_password === "")
            {
            change_password_error("Enter new password", "orange");
            set_focus("new_password");
            return false;
            }

        if (new_password.length < 8) 
            {
            change_password_error("New password must be 8 characters or longer", "orange");
            set_focus("new_password");
            return false;
            }

        if (new_password !== confirm_password)
            {
            change_password_error("The passwords you typed<br/>do not match", "orange");
            set_focus("new_password");
            return false;
            }

        api({
            method: "ChangePassword",
            args: {
                old_password: old_password,
                new_password: new_password
            }
        }, function(call)
            {
            if (call !== null)
                {
                if (call.status === "1")
                    {
                    change_password_error("Your password has been updated", cr_teal);
                    id("confirm_password").value = "";
                    id("confirm_password").blur();
                    }
                else change_password_error("Not authorized", "orange");
                }
            });
        return false;
        }

//--------------------------------------------------------------------------------------------------

    // INIT FUNCTION

    function init()
        {
        //id("page_title").innerHTML = "Welcome, " + window.session.username;
        
        populate_account_data();
        transaction_report();
        }
        
</script>
<script type="text/javascript">
    window.nav_text = "My Account";
</script>
<script type="text/javascript" src="/js/nav.js"></script>
<!--#include virtual="/ssi/google_analytics.html" -->
</body>
</html>
