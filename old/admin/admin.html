<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>CoinRoster | Admin Panel</title>
    <!--#include virtual="/ssi/head_admin.html" -->
</head>
<body>   
<input type="password" style="position:absolute;top:-1000px;"/>
<div id="header"></div>
<!--#include virtual="/ssi/nav.html" -->
<div id="nav"></div>
<div id="content_0" class="content_wrapper">
    <div class="content_header">
        <div class="content_header_title">
            <span id="number_of_users"></span>
            Users
        </div>
        <table class="settings">
            <tr>
                <td>
                    Sort:
                </td>
                <td>
                    <select id="user_report_sort_selector" class="input_style chosen-select" style="width:150px">
                        <option selected>Recently Joined</option>
                        <option>Username</option>
                        <option>BTC High to Low</option>
                        <option>RC High to Low</option>
                        <option>Last Login</option>
                    </select>
                </td>
                <td>
                    <input type="checkbox" name="checkbox" id="simple_user_report_checkbox" value="value">
                    <label for="simple_user_report_checkbox">Simple Report</label>
                </td>
                <td>
                    <input type="checkbox" name="checkbox" id="exclude_internals_checkbox" value="value">
                    <label for="exclude_internals_checkbox">Exclude Internal Accounts</label>
                </td>
                <!--<td>
                    with keywords:
                </td>
                <td>
                    <input id="search_bar" class="search input_style text_input" placeholder="Enter keywords..." style="width:300px">
                </td>
                <td>
                    <button type="button" class="input_style" style="background:rgb(168,243,201)" onclick="sort_user_report();">Go!</button>
                </td>-->
            </tr>
        </table>
        <img src="../img/excel.png" class="excel_button" onclick="pop_up_simple_table('user_report_table');"/>
    </div>
    <div class="content_body">
        <div id="user_report_table" class="report_table"></div>
    </div>
</div>
<div id="content_1" class="content_wrapper">
    <div class="content_header" style="height:155px">
        <div class="content_header_title">Transaction Report</div>
        <table class="settings">
            <tr>
                <td>
                    Date Range:
                </td>
                <td>
                    <input type="text" class="input_style text_input tcal" id="transaction_date_start_tcal">
                </td>
                <td>
                    to
                </td>
                <td>
                    <input type="text" class="input_style text_input tcal" id="transaction_date_end_tcal">
                </td>
                <td>
                    <button type="button" class="input_style" style="background:rgb(168,243,201)" onclick="transaction_report();">Go!</button>
                </td>
            </tr>
        </table>
        <table class="settings" style="top:108px">
            <tr>
                <td>
                    Filter by transaction type:
                </td>
                <td>
                    <select data-placeholder="Select" id="transaction_type_selector" class="input_style chosen-select" style="width:210px">
                        <option></option>
                        <option>BTC-DEPOSIT</option>
                        <option>BTC-WITHDRAWAL</option>
                        <option>RC-DEPOSIT</option>
                        <option>RC-WITHDRAWAL</option>
                    </select>
                </td>
                <td>
                    Filter by user:
                </td>
                <td>
                    <select data-placeholder="Select" id="user_filter_selector" class="input_style chosen-select user_selector" style="width:330px">
                        <option></option>
                    </select>
                </td>
            </tr>
        </table>
        <img src="../img/excel.png" class="excel_button" onclick="pop_up_simple_table('transaction_report_table');"/>
    </div>
    <div class="content_body" style="top:156px">
        <div id="transaction_report_table" class="report_table"></div>
    </div>
</div>
<div id="content_2" class="content_wrapper">
    <div class="content_header">
        <div class="content_header_title">New Transaction</div>
        <table class="settings">
            <tr>
                <td>
                    Transaction Type:
                </td>
                <td>
                    <select data-placeholder="Select" id="new_trans_selector" class="input_style chosen-select" style="width:300px">
                        <option></option>
                        <option>BTC-DEPOSIT</option>
                        <option>BTC-WITHDRAWAL</option>
                        <option>RC-DEPOSIT</option>
                        <option>RC-WITHDRAWAL</option>
                    </select>
                </td>
            </tr>
        </table>
    </div>
    <div id="new_trans_view_0" class="content_body new_trans_window">
        <!-- NOTHING SELECTED -->
    </div>
    <div id="new_trans_view_1" class="content_body new_trans_window">
        <!-- BTC-DEPOSIT -->
        <table class="settings">
            <tr>
                <td>
                    Create new
                </td>
                <td>
                    <span class="new_transaction_type" style="font-weight:bold">BTC-DEPOSIT</span>
                </td>
            </tr>
            <tr style="height:20px"></tr>
            <tr>
                <td>
                    From:
                </td>
                <td class="grey_cell">
                    internal_btc_liability
                </td>
            </tr>
            <tr style="height:20px"></tr>
            <tr>
                <td>
                    To:
                </td>
                <td>
                    <select data-placeholder="Select" class="input_style chosen-select user_selector" onchange="new_trans_user_balance(this, 'BTC');" style="width:330px">
                        <option></option>
                    </select>
                </td>
                <td class="transaction_user_balance">
                    <!-- BALANCE -->
                </td>
                <td>
                    BTC
                </td>
            </tr>
            <tr style="height:20px"></tr>
            <tr>
                <td>
                    Amount (BTC):
                </td>
                <td>
                    <input type="text" class="input_style text_input transaction_amount">
                </td>
            </tr>
            <tr style="height:20px"></tr>
            <tr>
                <td>
                    Memo:
                </td>
                <td>
                    <input type="text" class="input_style text_input transaction_memo" maxlength="60" style="width:330px">
                </td>
            </tr>
            <tr style="height:20px"></tr>
            <tr>
                <td>
                    <button type="button" class="input_style" style="background:rgb(168,243,201)" onclick="submit_new_trans();">Submit Transaction</button>
                </td>
            </tr>
        </table>
    </div>
    <div id="new_trans_view_2" class="content_body new_trans_window">
        <!-- BTC-WITHDRAWAL -->
        <table class="settings">
            <tr>
                <td>
                    Create new
                </td>
                <td>
                    <span class="new_transaction_type" style="font-weight:bold">BTC-WITHDRAWAL</span>
                </td>
            </tr>
            <tr style="height:20px"></tr>
            <tr>
                <td>
                    From:
                </td>
                <td>
                    <select data-placeholder="Select" class="input_style chosen-select user_selector" onchange="new_trans_user_balance(this, 'BTC');" style="width:330px">
                        <option></option>
                    </select>
                </td>
                <td class="transaction_user_balance">
                    <!-- BALANCE -->
                </td>
                <td>
                    BTC
                </td>
            </tr>
            <tr style="height:20px"></tr>
            <tr>
                <td>
                    To:
                </td>
                <td class="grey_cell">
                    internal_btc_liability
                </td>
            </tr>
            <tr style="height:20px"></tr>
            <tr>
                <td>
                    Amount (BTC):
                </td>
                <td>
                    <input type="text" class="input_style text_input transaction_amount">
                </td>
            </tr>
            <tr style="height:20px"></tr>
            <tr>
                <td>
                    Memo:
                </td>
                <td>
                    <input type="text" class="input_style text_input transaction_memo" maxlength="60" style="width:330px">
                </td>
            </tr>
            <tr style="height:20px"></tr>
            <tr>
                <td>
                    <button type="button" class="input_style" style="background:rgb(168,243,201)" onclick="submit_new_trans();">Submit Transaction</button>
                </td>
            </tr>
        </table>
    </div>
    <div id="new_trans_view_3" class="content_body new_trans_window">
        <!-- RC-DEPOSIT -->
        <table class="settings">
            <tr>
                <td>
                    Create new
                </td>
                <td>
                    <span class="new_transaction_type" style="font-weight:bold">RC-DEPOSIT</span>
                </td>
            </tr>
            <tr style="height:20px"></tr>
            <tr>
                <td>
                    From:
                </td>
                <td class="grey_cell">
                    internal_rc_liability
                </td>
            </tr>
            <tr style="height:20px"></tr>
            <tr>
                <td>
                    To:
                </td>
                <td>
                    <select data-placeholder="Select" class="input_style chosen-select user_selector" onchange="new_trans_user_balance(this, 'RC');" style="width:330px">
                        <option></option>
                    </select>
                </td>
                <td class="transaction_user_balance">
                    <!-- BALANCE -->
                </td>
                <td>
                    RC
                </td>
            </tr>
            <tr style="height:20px"></tr>
            <tr>
                <td>
                    Amount (RC):
                </td>
                <td>
                    <input type="text" class="input_style text_input transaction_amount">
                </td>
            </tr>
            <tr style="height:20px"></tr>
            <tr>
                <td>
                    Memo:
                </td>
                <td>
                    <input type="text" class="input_style text_input transaction_memo" maxlength="60" style="width:330px">
                </td>
            </tr>
            <tr style="height:20px"></tr>
            <tr>
                <td>
                    <button type="button" class="input_style" style="background:rgb(168,243,201)" onclick="submit_new_trans();">Submit Transaction</button>
                </td>
            </tr>
        </table>
    </div>
    <div id="new_trans_view_4" class="content_body new_trans_window">
        <!-- RC-WITHDRAWAL -->
        <table class="settings">
            <tr>
                <td>
                    Create new
                </td>
                <td>
                    <span class="new_transaction_type" style="font-weight:bold">RC-WITHDRAWAL</span>
                </td>
            </tr>
            <tr style="height:20px"></tr>
            <tr>
                <td>
                    From:
                </td>
                <td>
                    <select data-placeholder="Select" class="input_style chosen-select user_selector" onchange="new_trans_user_balance(this, 'RC');" style="width:330px">
                        <option></option>
                    </select>
                </td>
                <td class="transaction_user_balance">
                    <!-- BALANCE -->
                </td>
                <td>
                    RC
                </td>
            </tr>
            <tr style="height:20px"></tr>
            <tr>
                <td>
                    To:
                </td>
                <td class="grey_cell">
                    internal_rc_liability
                </td>
            </tr>
            <tr style="height:20px"></tr>
            <tr>
                <td>
                    Amount (RC):
                </td>
                <td>
                    <input type="text" class="input_style text_input transaction_amount">
                </td>
            </tr>
            <tr style="height:20px"></tr>
            <tr>
                <td>
                    Memo:
                </td>
                <td>
                    <input type="text" class="input_style text_input transaction_memo" maxlength="60" style="width:330px">
                </td>
            </tr>
            <tr style="height:20px"></tr>
            <tr>
                <td>
                    <button type="button" class="input_style" style="background:rgb(168,243,201)" onclick="submit_new_trans();">Submit Transaction</button>
                </td>
            </tr>
        </table>
    </div>
</div>
<div id="content_3" class="content_wrapper">
    <div class="content_header" style="height:67px">
        <div class="content_header_title">
            Pending Referrals
        </div>
        <img src="../img/excel.png" class="excel_button" onclick="pop_up_simple_table('referral_report_table');"/>
    </div>
    <div class="content_body" style="top:68px">
        <div id="referral_report_table" class="report_table"></div>
    </div>
</div>
<div id="content_4" class="content_wrapper">
    <div class="content_header" style="height:67px">
        <div class="content_header_title">
            Passwords
        </div>
    </div>
    <div class="content_body" style="top:68px">
        <input id="password_key" placeholder="Enter current key" type="password" class="input_style text_input transaction_memo" style="width:500px">
        <button type="button" class="input_style" style="background:rgb(168,243,201)" onclick="show_passwords();">Show Passwords</button>
        <button type="button" class="input_style" style="background:rgb(168,243,201)" onclick="update_passwords();">Update Passwords</button>
        <button type="button" class="input_style" style="background:rgb(168,243,201)" onclick="clear_fields();">Reset Form</button>
        <br/>
        <br/>
        <input id="new_password_key" placeholder="Enter new key (only needed if changing the key)" type="password" class="input_style text_input transaction_memo" style="width:500px">
        <button type="button" class="input_style" style="background:rgb(168,243,201)" onclick="change_key();">Change Key</button>
        <br/>
        <br/>
        <textarea id="password_textarea" rows="40" cols="150"></textarea> 
    </div>
</div>
<script>

    var 
    
    nav = id("nav"),
    tabs = [
        "User Report",
        "Transaction report",
        "New Transaction",
        "Pending Referrals",
        "Passwords"
    ],
    nav_nodes = [],
    nav_selection = -1;

    for (var i=0; i<tabs.length; i++)
        {
        var  nav_node = document.createElement("a");
        nav_node.className = "link";
        nav_node.innerHTML = tabs[i];
        nav_node.onclick = (function(i)
            {
            return function()
                {
                changeNavSelection(i);
                };
            })(i);
        nav.appendChild(nav_node);
        nav_nodes[i] = nav_node;
        }
    changeNavSelection(0);

    function changeNavSelection(selection)
        {
        if (selection !== nav_selection)
            {
            nav_nodes[selection].className = "link selected";
            if (nav_selection !== -1)
                {
                nav_nodes[nav_selection].className = "link";
                id("content_" + nav_selection).style.display = "none";
                }
            id("content_" + selection).style.display = "block";
            $('#content_' + selection).find('.chosen-select').chosen({
                disable_search_threshold: 10,
                allow_single_deselect: true
            });
            nav_selection = selection;
            
            switch(selection)
                {
                case 0: /* USER REPORT */
                    
                    break;
                case 1: /* TRANSACTION REPORT */
                    transaction_report();
                    break;
                case 2: /* NEW TRANSACTION */
                    
                    break;
                case 3: /* REFERRALS PENDING */
                    referral_report();
                    break;
                }
            }
        }

    /*----------------------------------------------------------------------*/
    
    /*var search_bar = id("search_bar");
    
    search_bar.addEventListener("keydown", function(e)
        {
        var code = e.keyCode || e.which;
        if (code === 13)
            {
            work_order_lookup();
            }
        }, false);*/

    /*----------------------------------------------------------------------*/
 
    function pop_up_simple_table(_id)
        {
        var newWindow = window.open('simple_table.html');
        newWindow.table_html = id(_id).innerHTML;
        }
            
    /*----------------------------------------------------------------------*/
     
    var now = new Date(),
            
    createDatePicker = function(id, onselect)
        {
        return new datepicker(
            {
            field: id,
            firstDay: 1,
            minDate: new Date("2000-01-01"),
            maxDate: now,
            defaultDate: now,
            setDefaultDate: true,
            yearRange: [2000,2020],
            onSelect: onselect
            });
        };
        
    /*----------------------------------------------------------------------*/  

    var user_report_sort_selector = id("user_report_sort_selector");
    
    user_report_sort_selector.onchange = function()
        {
        sort_user_report();
        };
        
    /*----------------------------------------------------------------------*/
 
    Array.prototype.contains = function(value) 
        {
        for (var i=0; i<this.length; i++) if (this[i] === value) return true;
        return false;
        };
 
    var 
    
    now = new Date(),
    now_day_of_month = now.getDate(),
    now_ms = now.getTime(),
    
    ms_per_day = (86400 * 1000),
            
    left_date = now_ms - ms_per_day * (now_day_of_month - 1),
    right_date = now_ms,
    
    min_date = null,
    max_date = now_ms;
    
    initialize_linked_calendars
        (
        id("transaction_date_start_tcal"), 
        id("transaction_date_end_tcal"), 
        left_date, 
        right_date,
        min_date,
        max_date
        );

    var
    
    transaction_type_selector = id("transaction_type_selector"),
    user_filter_selector = id("user_filter_selector");
    
    transaction_type_selector.onchange = function()
        {
        populate_transaction_report_table();
        };
        
    user_filter_selector.onchange = function()
        {
        populate_transaction_report_table();
        };

    /*----------------------------------------------------------------------*/
    
    function new_table(parent)
        {
        var parent_element = id(parent);
        parent_element.innerHTML = "";
        var table = document.createElement("table");
        parent_element.appendChild(table);
        return table;
        }

    var 
    
    number_of_users,
    user_report_array = [],
    
    internal_btc_liability_id = "",
    internal_btc_asset_id = "",
    internal_rc_liability_id = "";
    
    function user_report()
        {
        var call = api({
            method: "user_report",
            args: {}
        });
        
        var user_report = call.user_report;
        number_of_users = user_report.length;

        id("number_of_users").innerHTML = number_of_users;

        for (var i=0; i<number_of_users; i++)
            {
            var user_item = user_report[i],
            created = user_item.created,
            last_login = user_item.last_login,
            user_id = user_item.user_id,
            username = user_item.username,
            user_level = user_item.user_level,
            btc_balance = user_item.btc_balance,
            rc_balance = user_item.rc_balance,
            email_address = user_item.email_address,
            email_ver_flag = user_item.email_ver_flag,
            newsletter_flag = user_item.newsletter_flag,
            referral_program = user_item.referral_program,
            referrer_username = user_item.referrer_username;
    
            if (user_level === "2")
                {
                if (username === "internal_btc_liability") internal_btc_liability_key = user_id;
                else if (username === "internal_btc_asset") internal_btc_asset_key = user_id;
                else if (username === "internal_rc_liability") internal_rc_liability_key = user_id;
                }
    
            if (email_address === "") 
                {
                email_address = "";
                email_ver_flag = "";
                newsletter_flag = "";
                }
            if (referrer_username === "") 
                {
                referrer_username = "";
                referral_program = "";
                }
            
            user_report_array.push([
                created,
                user_id,
                username,
                user_level,
                btc_balance,
                rc_balance,
                email_address,
                email_ver_flag,
                newsletter_flag,
                referral_program,
                referrer_username,
                last_login
            ]);
            }
        }
        
    user_report();
    sort_user_report();
             
    simple_user_report_checkbox = id("simple_user_report_checkbox");      
    simple_user_report_checkbox.onchange = function()
        {
        sort_user_report();
        };
         
    exclude_internals_checkbox = id("exclude_internals_checkbox");      
    exclude_internals_checkbox.onchange = function()
        {
        sort_user_report();
        };
  
    function get_username_for_id(user_id)
        {
        for (var i=0; i<number_of_users; i++)
            {
            if (user_report_array[i][1] === user_id) return user_report_array[i][2];
            }
        }
        
    function sort_user_report()
        {
        function new_row(table, row_index, data)
            {
            var row = table.insertRow(row_index),
            array = [row];
            for (var i=0; i<data.length; i++)
                {
                var cell = row.insertCell(i); 
                cell.innerHTML = data[i];
                array.push(cell);
                }
            return array;
            }
               
        var 

        simple_user_report = simple_user_report_checkbox.checked,
        exclude_internal_accounts = exclude_internals_checkbox.checked;

        var table = new_table("user_report_table"),
        row_count = 0,
        header;

        if (simple_user_report)
            {
            header = new_row(table, row_count++, [
                "Username",
                "Level",
                "BTC",
                "RC"
            ]);
            
            header[3].style.textAlign = "right";
            header[4].style.textAlign = "right";
            }
        else
            {
            header = new_row(table, row_count++, [
                "Joined",
                "Username",
                "Last Login",
                "BTC",
                "RC",
                "E-mail",
                "Verified",
                "Subscribed",
                "Referral PGM",
                "Referrer",
                "Level"
            ]);

            header[4].style.textAlign = "right";
            header[5].style.textAlign = "right";
            header[9].style.textAlign = "right";
            }

        // style headers:
        
        for (var i=1; i<header.length; i++) header[i].className = "header_cell";
        
        // sort report:
        
        switch(user_report_sort_selector.selectedIndex)
            {
            case 0: // Created date
                user_report_array.sort(function(a, b)
                    {
                    return b[0] - a[0];
                    });
                break;
            case 1: // AlphaNumeric
                user_report_array.sort(function(a, b)
                    {
                    a = a[2].toLowerCase();
                    b = b[2].toLowerCase();
                    return (a === b ? 0 : (a < b ? -1 : 1));
                    });
                break;
            case 2: // BTC Balance High to Low
                user_report_array.sort(function(a, b)
                    {
                    return b[4] - a[4];
                    });
                break;
            case 3: // RC Balance High to Low
                user_report_array.sort(function(a, b)
                    {
                    return b[5] - a[5];
                    });
                break;
            case 4: // Last Login
                user_report_array.sort(function(a, b)
                    {
                    return b[11] - a[11];
                    });
                break;
            }
        
        // create rows:
        
        for (var i=0; i<number_of_users; i++)
            {
            var show_row = true,
            
            user_item = user_report_array[i],
                    
            created = user_item[0],
            //user_id = user_item[1], * not used here
            username = user_item[2],
            user_level = user_item[3],
            btc_balance = user_item[4],
            rc_balance = user_item[5],
            email_address = user_item[6],
            email_ver_flag = user_item[7],
            newsletter_flag = user_item[8],
            referral_program = user_item[9],
            referrer_username = user_item[10],
            last_login = user_item[11];
    
            created = dateconv_ms_to_string(created);
    
            if (user_level === "1") user_level = "admin";
            else if (user_level === "2") 
                {
                user_level = "internal";
                if (exclude_internal_accounts) show_row = false;
                }
            else user_level = "normal";
            
            if (email_ver_flag === "1") email_ver_flag = "yes";
            else email_ver_flag = "";
            
            if (newsletter_flag === "1") newsletter_flag = "yes";
            else newsletter_flag = "";

            if (last_login === "0") last_login = "";
            else last_login = timeSince(last_login);
    
            if (show_row) 
                {
                if (simple_user_report)
                    {
                    var row = new_row(table, row_count++, [
                        username,
                        user_level,
                        btc_balance,
                        rc_balance
                    ]);

                    row[3].style.textAlign = "right";
                    row[4].style.textAlign = "right";
                    }
                else
                    {
                    var row = new_row(table, row_count++, [
                        created,
                        username,
                        last_login,
                        btc_balance,
                        rc_balance,
                        email_address,
                        email_ver_flag,
                        newsletter_flag,
                        referral_program,
                        referrer_username,
                        user_level
                    ]);

                    row[4].style.textAlign = "right";
                    row[5].style.textAlign = "right";
                    row[9].style.textAlign = "right";
                    }
                }
            }
        }
            
    /*----------------------------------------------------------------------*/
    
    var 
    
    number_of_transactions,
    transaction_report_array = [];

    function transaction_report()
        {
        var 
        
        start_date_ms = id("transaction_date_start_tcal").date_ms, 
        end_date_ms = id("transaction_date_end_tcal").date_ms;

        start_date_ms = ((start_date_ms / ms_per_day) | 0) * ms_per_day;
        end_date_ms = ((end_date_ms / ms_per_day) | 0) * ms_per_day + ms_per_day;

        var call = api({
            method: "transaction_report",
            args: {
                start_date_ms: start_date_ms,
                end_date_ms: end_date_ms,
                request_source: "admin_panel"
            }
        });
        
        if (call.status === "1") 
            {
            transaction_report_array = call.transaction_report;
            number_of_transactions = transaction_report_array.length;
            populate_transaction_report_table();
            }
        }
        
    function populate_transaction_report_table()
        {
        function new_row(table, row_index, data)
            {
            var row = table.insertRow(row_index),
            array = [row];
            for (var i=0; i<data.length; i++)
                {
                var cell = row.insertCell(i); 
                cell.innerHTML = data[i];
                array.push(cell);
                }
            array[8].style.textAlign = "right";
            return array;
            }
       
        var table = new_table("transaction_report_table"),
        row_count = 0,
        there_are_rows = false;

        if (number_of_transactions > 0)
            {
            var

            type_filtering_on = false,
            user_filtering_on = false,

            trans_type_filter = selectorHTML(transaction_type_selector),
            user_filter = selectorValue(user_filter_selector);

            if (trans_type_filter !== "") type_filtering_on = true;
            if (user_filter !== "") user_filtering_on = true;

            // create rows:

            for (var i=number_of_transactions-1; i>=0; i--)
                {
                var show_row = true,

                transaction_item = transaction_report_array[i],

                transaction_id = transaction_item.transaction_id,
                created = transaction_item.created,
                created_by = transaction_item.created_by,
                trans_type = transaction_item.trans_type,
                from_account = transaction_item.from_account,
                to_account = transaction_item.to_account,
                amount = transaction_item.amount,
                from_currency = transaction_item.from_currency,
                to_currency = transaction_item.to_currency,
                memo = transaction_item.memo;

                if (type_filtering_on && trans_type !== trans_type_filter) show_row = false;
                if (user_filtering_on && !(from_account === user_filter || to_account === user_filter)) show_row = false;

                if (show_row)
                    {
                    there_are_rows = true;
                    
                    var
                    
                    created_date = dateconv_ms_to_string(created),
                    created_time = dateconv_ms_to_time(created);
            
                    created_by = get_username_for_id(created_by);
                    from_account = get_username_for_id(from_account);
                    to_account = get_username_for_id(to_account);

                    new_row(table, row_count++, [
                        transaction_id,
                        created_date,
                        created_time,
                        created_by,
                        trans_type,
                        from_account,
                        to_account,
                        amount,
                        from_currency,
                        to_currency,
                        memo
                    ]);
                    }
                }
            }

        if (there_are_rows)
            {
            var header = new_row(table, 0, [
                "#",
                "Date",
                "Time",
                "Created By",
                "Type",
                "From",
                "To",
                "Amount",
                "From Currency",
                "To Currency",
                "Memo"
            ]);
            // style headers:

            for (var i=1; i<header.length; i++) header[i].className = "header_cell";
            }
        else id("transaction_report_table").innerHTML = "No transactions match your criteria";
        }
        
    /*----------------------------------------------------------------------*/
    
    user_report_array.sort(function(a, b)
        {
        a = a[2].toLowerCase();
        b = b[2].toLowerCase();
        return (a === b ? 0 : (a < b ? -1 : 1));
        });

    var new_trans_user_selectors = document.getElementsByClassName("user_selector");
    
    for (var s=0; s<new_trans_user_selectors.length; s++)
        {
        var selector = new_trans_user_selectors[s];
        
        for (var i=0; i<number_of_users; i++)
            {
            var 

            user_item = user_report_array[i],

            user_id = user_item[1],
            username = user_item[2],
            user_level = user_item[3];

            if (user_level !== "2")
                {
                var option = document.createElement("option");
                option.value = user_id;
                option.innerHTML = username;
                selector.appendChild(option);
                }
            }
        $(selector).trigger("chosen:updated");
        }

    var new_trans_selector = id("new_trans_selector"),
    new_transaction_type = 0;
    
    new_trans_selector.onchange = function()
        {
        var view_id = new_trans_selector.selectedIndex;
        show_new_trans_view(view_id);
        };
    
    function show_new_trans_view(view_id)
        {
        if (view_id !== new_transaction_type)
            {
            id("new_trans_view_" + view_id).style.visibility = "visible";
            id("new_trans_view_" + new_transaction_type).style.visibility = "hidden";
            new_transaction_type = view_id;
            }
        }
        
    function new_trans_user_balance(selector_element, currency)
        {
        var 
        
        user_id = selectorValue(selector_element),
        currency_index = currency === "BTC" ? 4 : 5,
        balance = "";

        for (var i=0; i<number_of_users; i++)
            {
            if (user_report_array[i][1] === user_id)
                {
                balance = user_report_array[i][currency_index];
                break;
                }
            }
        selector_element.parentElement.nextElementSibling.innerHTML = balance;
        }
        
    function submit_new_trans()
        {
        var 
        
        transaction_view = id("new_trans_view_" + new_transaction_type),
        transaction_type = transaction_view.getElementsByClassName("new_transaction_type")[0].innerHTML,
        user_account = selectorValue(transaction_view.getElementsByClassName("user_selector")[0]),
        transaction_user_balance = transaction_view.getElementsByClassName("transaction_user_balance")[0].innerHTML,
        transaction_amount = transaction_view.getElementsByClassName("transaction_amount")[0].value,
        transaction_memo = transaction_view.getElementsByClassName("transaction_memo")[0].value;

        if (user_account === "") return alert("No user selected");
        
        if (transaction_amount === "") return alert("Please enter an amount");
        transaction_amount = Number(transaction_amount);
        if (isNaN(transaction_amount)) return alert("Amount is not a number");
        if (transaction_amount <= 0) return alert("Amount cannot be less than or equal to 0");

        // for withdrawals, amounnt cannot be greater than balance:
        
        if (transaction_type === "BTC-WITHDRAWAL" || transaction_type === "RC-WITHDRAWAL")
            {
            if (transaction_amount > Number(transaction_user_balance)) return alert("User has insufficient funds");
            }

        var call = api({
            method: "new_transaction",
            args: {
                transaction_type: transaction_type,
                user_account: user_account,
                amount: transaction_amount,
                memo: transaction_memo
            }
        });
        
        if (call.status === "1") 
            {
            alert("Transaction created! Reloading panel.");
            location.reload();
            }
        else alert("Error: " + call.error);
        }
        
    /*----------------------------------------------------------------------*/

    var referral_report_array = null;
    
    function referral_report()
        {
        if (referral_report_array !== null) return;
        
        function new_row(table, row_index, data)
            {
            var row = table.insertRow(row_index),
            array = [row];
            for (var i=0; i<data.length; i++)
                {
                var cell = row.insertCell(i); 
                cell.innerHTML = data[i];
                array.push(cell);
                }
            return array;
            }
            
        var call = api({
            method: "referral_report",
            args: {}
        });
        
        referral_report_array = call.referral_report;
        
        var number_of_referrals = referral_report_array.length,
        table = new_table("referral_report_table"),
        row_count = 0;

        if (number_of_referrals > 0)
            {
            // create rows:
            
            referral_report_array.sort(function(a, b)
                {
                return a.created - b.created;
                });

            for (var i=number_of_referrals-1; i>=0; i--)
                {
                var referral_item = referral_report_array[i],
                    
                created = referral_item.created,
                created_date = dateconv_ms_to_string(created),
                created_time = dateconv_ms_to_time(created),
                referral_key = referral_item.referral_key,
                referrer_username = referral_item.referrer_username,
                email_address = referral_item.email_address,
                referral_pgm = referral_item.referral_pgm;

                new_row(table, row_count++, [
                    created_date,
                    created_time,
                    referrer_username,
                    email_address,
                    referral_pgm,
                    referral_key
                ]);
                }
                
            var header = new_row(table, 0, [
                "Date",
                "Time",
                "Referrer",
                "To",
                "Refferal PGM",
                "Key"
            ]);
            // style headers:

            for (var i=1; i<header.length; i++) header[i].className = "header_cell";
            }
        else 
            {
            id("referral_report_table").innerHTML = "No pending referrals";
            referral_report_array = "not null";
            }
        }
        
    /*----------------------------------------------------------------------*/

    id("password_key").value = "";
    
    function show_passwords()
        {
        var key = id("password_key").value;

        var call = api({
            method: "show_passwords",
            args: {
                key: key
            }
        });
        
        if (call.status === "1") id("password_textarea").value = call.password_blob;
        else
            {
            clear_fields();
            alert("Wrong key");
            }
        }
    
    function update_passwords()
        {
        var 
        
        key = id("password_key").value,
        blob = id("password_textarea").value;

        if (blob === "") return alert("Text area is blank!");
        
        var do_it = confirm('Are you sure you want to update passwords?');
        
        if (do_it)
            {
            var call = api({
                method: "update_passwords",
                args: {
                    key: key,
                    blob: blob
                }
            });

            if (call.status === "1")
                {
                clear_fields();
                alert("Encrypted password blob has been updated!");
                }
            else
                {
                id("password_key").value = "";
                alert(call.error);
                }
            }
        }
    
    function change_key()
        {
        var 
        
        key = id("password_key").value,
        new_key = id("new_password_key").value;

        if (key === "") return alert("Please enter current key");
        if (new_key === "") return alert("Please enter new key");
        
        var call = api({
            method: "update_password_key",
            args: {
                key: key,
                new_key: new_key
            }
        });

        clear_fields();
        
        if (call.status === "1") alert("Encryption key has been updated!");
        else alert(call.error);
        }
    
    function clear_fields()
        {
        id("password_key").value = "";
        id("new_password_key").value = "";
        id("password_textarea").value = "";
        }
        
</script>
</body>
</html>