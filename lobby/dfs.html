<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>CoinRoster | Lobby</title>
    <!--#include virtual="/ssi/head.html" -->
    <link rel="stylesheet" type="text/css" href="/css/lobby.css">
    <script type="text/javascript" src="/js/lobby.js"></script>
    <script type="text/javascript" src="/js/account.js"></script>
</head>
<body>
<!--#include virtual="/ssi/nav.html" -->
<!--#include virtual="/ssi/simple_modal.html" -->
<div id="centering_container">
    <div id="body_container">
        <div id="page_title" class="orange"></div>
        <span id="contest_description"></span>
        <br/>
        <br/>
        <br/>
        <table class="contest_detail_table">
            <tr>
                <td>
                    Category:
                </td>
                <td>
                    <span id="category" class="orange"></span>
                </td>
            </tr>
            <tr>
                <td>
                    Game type:
                </td>
                <td>
                    <span id="settlement_type" class="orange"></span>
                </td>
                <td>
                    <div id="payout_info" class="payout_info_link blue">Payout info</div>
                </td>
            </tr>
            <tr>
                <td>
                    Entry fee:
                </td>
                <td>
                    <span id="cost_per_entry" class="orange"></span>
                </td>
            </tr>
            <tr>
                <td>
                    Number of entries
                </td>
                <td>
                    <input id="number_of_entries_input" type="text" class="input_style text_input" value="1">
                </td>
            </tr>
        </table>
        <br/>
        <div id="enter_contest" style="display:none">
            <div id="player_table_header">
                <div id="salary_cap_container">
                    Remaining salary:&nbsp;&nbsp;&nbsp;&nbsp;<span id="salary_cap" class="green"></span>
                </div>
            </div><!--
            --><div id="roster_table_header">
                <div id="remaining_players_container">
                    Players drafted:&nbsp;&nbsp;&nbsp;&nbsp;<span id="remaining_players" class="green"></span>
                </div>
            </div>
            <div id="player_table_container">
                <table id="player_table" class="player_table"></table>
            </div><!--
            --><div id="roster_table_container">
                <table id="roster_table" class="player_table"></table>
            </div>
            <div id="submit_button_container">
                <button id="submit_roster_button" class="text_button auto_width" onclick="submit_roster()"></button>
            </div>
        </div>
        <div id="no_entry" style="display:none">
            This contest is not open for registration.
        </div>
    </div>
</div>
<script>

    function init()
        {
        var contest_id = get_url_param("id");
        
        window.contest_id = contest_id;
        
        if (contest_id !== null)
            {
            api({
                method: "GetContestDetails",
                args: {
                    contest_id: contest_id
                }
            }, function(call)
                {
                if (call.status === "1")
                    {
                    var
                    
                    category = call.category,
                    sub_category = call.sub_category,
                    title = call.title,
                    description = call.description,
                    settlement_type = call.settlement_type,
                    pay_table = call.pay_table,
                    odds_table = call.odds_table,
                    salary_cap = call.salary_cap,
                    cost_per_entry = call.cost_per_entry,
                    min_users = call.min_users,
                    max_users = call.max_users,
                    entries_per_user = call.entries_per_user,
                    contest_status = call.contest_status,
                    roster_size = call.roster_size;
            
                    window.cost_per_entry = cost_per_entry;
            
                    id("page_title").innerHTML = title;
                    id("contest_description").innerHTML = description;
                    
                    id("category").innerHTML = category + " / " + sub_category;
                    id("settlement_type").innerHTML = settlement_type;
                    id("cost_per_entry").innerHTML = cost_per_entry + " BTC";
                    
                    bind_payout_window(id("payout_info"), settlement_type, pay_table, entries_per_user);
                    
                    if (contest_status === 1 /* and other criteria met */)
                        {
                        id("submit_roster_button").innerHTML = "Submit roster (" + cost_per_entry + " BTC)";
                        initialize_entry_UI(JSON.parse(odds_table), salary_cap, roster_size);
                        }
                    else 
                        {
                        show("no_entry");
                        }
                    }
                else show_simple_modal(call.error, "bad", null);
                });
            }
        else show_simple_modal("No contest ID supplied", "bad", null);
        }
        
    function initialize_entry_UI(odds_table, salary_cap, roster_size)
        {
        show("enter_contest");
        
        id("salary_cap").innerHTML = "$" + toCurrency(salary_cap);
        
        if (roster_size !== 0)
            {
            show("remaining_players_container", "inline-block");
            id("remaining_players").innerHTML = "0/" + roster_size;
            }
            
        for (var i=0; i<odds_table.length; i++)
            {
            var player_item = odds_table[i],
                    
            player_id = player_item.id,
            name = player_item.name,
            price = player_item.price;
    
            insert_player_row("player_table", player_id, name, price);
            }
        }
        
    function add_player(player_id)
        {
        var row = id("player_" + player_id),
                
        name = row.name,
        price = row.price,
        
        salary_cap = fromCurrency(id("salary_cap").innerHTML),
        remaining_players = id("remaining_players").innerHTML,
        
        drafted,
        max_players = 0;

        if (remaining_players !== "")
            {
            remaining_players = remaining_players.split("/");
            drafted = remaining_players[0];
            max_players = remaining_players[1];
            }

        if (max_players > 0 && drafted === max_players) show_simple_modal("Your roster is full", "bad", null);
        else if (price <= salary_cap)
            {
            id("salary_cap").innerHTML = "$" + toCurrency(salary_cap - price);
            if (max_players > 0) id("remaining_players").innerHTML = ++drafted + "/" + max_players;
            id("player_table").deleteRow(row.rowIndex);
            insert_player_row("roster_table", player_id, name, price);
            }
        else show_simple_modal("You cannot afford to draft " + name, "bad", null);
        }
        
    function remove_player(player_id)
        {
        var row = id("player_" + player_id),
                
        name = row.name,
        price = row.price,
        
        salary_cap = fromCurrency(id("salary_cap").innerHTML),
        remaining_players = id("remaining_players").innerHTML;
        
        if (remaining_players !== "")
            {
            remaining_players = remaining_players.split("/");
            
            var
            drafted = remaining_players[0],
            max_players = remaining_players[1];
    
            id("remaining_players").innerHTML = --drafted + "/" + max_players;
            }
        
        id("salary_cap").innerHTML = "$" + toCurrency(salary_cap + price);
        id("roster_table").deleteRow(row.rowIndex);
        
        insert_player_row("player_table", player_id, name, price);
        }
        
    function insert_player_row(table_id, player_id, name, price)
        {
        var 
        
        table = id(table_id),
        number_of_rows = table.rows.length,
        row_index = -1,
        action_button;

        if (table_id === "player_table") action_button = "<button class=\"text_button auto_width\" onclick=\"add_player(" + player_id + ")\">Buy</button>";
        else action_button = "<button class=\"text_button auto_width\" onclick=\"remove_player(" + player_id + ")\">Sell</button>";

        if (number_of_rows !== 0)
            {
            for (var i=0; i<number_of_rows; i++)
                {
                var row = table.rows[i];
                if (player_id < row.player_id)
                    {
                    row_index = row.rowIndex;
                    break;
                    }
                }
            }
            
        var row = new_row(table, row_index, [
            "<span class=\"\">" + name + "</span>",
            "<span class=\"green\">$" + toCurrency(price) + "</span>",
            action_button
        ]);
        
        row[0].id = "player_" + player_id;
        row[0].player_id = player_id,
        row[0].name = name;
        row[0].price = price;

        row[2].style.textAlign = "right";
        }
        
    function submit_roster()
        {     
        var remaining_players = id("remaining_players").innerHTML;
        
        if (remaining_players !== "")
            {
            remaining_players = remaining_players.split("/");
            
            var
            
            drafted = remaining_players[0],
            max_players = remaining_players[1];
    
            if (drafted !== max_players) return show_simple_modal("You must draft " + max_players + " players", "bad", null);
            }
            
        var 
        
        rows = id("roster_table").rows,
        number_of_players = rows.length,
        roster = [];

        if (number_of_players === 0) return show_simple_modal("You must draft at least one player", "bad", null);
        
        for (var i=0; i<number_of_players; i++)
            {
            var row = rows[i],
                    
            player_id = row.player_id,
            //name = row.name,
            price = row.price;
    
            roster.push({
                id: player_id,
                //name: name,
                price: price
            });
            }
            
        var use_rc = true;
        
        var number_of_entries = id("number_of_entries_input").value | 0;
        
        if (number_of_entries <= 0) return show_simple_modal("Invalid number of entries", "bad", null);
            
        api({ 
            method: "GetAccountDetails", 
            args: {} 
        }, function(call)
            {
            if (call.status === "1")
                {
                var 
                
                btc_balance = call.btc_balance,
                rc_balance = call.rc_balance,
                available_balance = btc_balance;
        
                if (use_rc) available_balance += rc_balance;
         
                if (window.cost_per_entry * number_of_entries > available_balance) return show_simple_modal("You have insufficient funds", "bad", null);
                
                api({
                    method: "CreateEntryDFS",
                    args: {
                        contest_id: window.contest_id,
                        number_of_entries: number_of_entries,
                        use_rc: true,
                        roster: roster
                    }
                }, function(call)
                    {
                    if (call.status === "1")
                        {
                        return show_simple_modal("You have successfully entered " + number_of_entries + " roster" + (number_of_entries > 1 ? "s" : ""), "good", function()
                            {
                            location.reload();
                            });
                        }
                    else alert(call.error);
                    });
                }
            });
        }
    
</script>
<script type="text/javascript" src="/js/nav.js"></script>
</body>
</html>
